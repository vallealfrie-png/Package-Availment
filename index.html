<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Revenue Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <nav class="bg-indigo-700 text-white px-8 py-4 flex flex-wrap justify-between items-center sticky top-0 z-50 shadow-md">
        <div class="flex items-center gap-2">
            <i data-lucide="activity" class="w-8 h-8"></i>
            <h1 class="text-xl font-bold tracking-tight">Healthcare Analytics Pro</h1>
        </div>
        <div class="flex flex-wrap gap-3 text-slate-800">
            <select id="monthSlicer" class="rounded-lg px-3 py-2 text-sm bg-white border-none shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none">
                <option value="all">All Months</option>
            </select>
            <select id="categorySlicer" class="rounded-lg px-3 py-2 text-sm bg-white border-none shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none">
                <option value="all">All Categories</option>
            </select>
            <select id="packageSlicer" class="rounded-lg px-3 py-2 text-sm bg-white border-none shadow-sm focus:ring-2 focus:ring-indigo-400 outline-none">
                <option value="all">All Packages</option>
            </select>
        </div>
    </nav>

    <main class="p-6 max-w-7xl mx-auto space-y-6">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Latest Month Revenue</p>
                <h2 id="currRev" class="text-3xl font-black mt-2 text-indigo-700">₱0</h2>
                <p id="currCensus" class="text-slate-500 text-sm font-semibold mt-1">0 Patients</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Previous Month</p>
                <h2 id="prevRev" class="text-3xl font-black mt-2 text-slate-600">₱0</h2>
                <p id="prevCensus" class="text-slate-500 text-sm font-semibold mt-1">0 Patients</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Revenue Variance</p>
                <div class="flex items-center gap-3 mt-2">
                    <h2 id="varRev" class="text-3xl font-black">0%</h2>
                    <div id="varIcon"></div>
                </div>
                <p class="text-slate-400 text-xs mt-1">Month-over-Month Growth</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4"></i> Revenue Trend</h3>
                </div>
                <canvas id="revChart" height="200"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> Patient Census</h3>
                </div>
                <canvas id="cenChart" height="200"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="text-center font-bold text-sm text-slate-500 mb-4 uppercase">By Location</h3>
                <canvas id="locChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="text-center font-bold text-sm text-slate-500 mb-4 uppercase">Gender Split</h3>
                <canvas id="genChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="text-center font-bold text-sm text-slate-500 mb-4 uppercase">Age Bracket</h3>
                <canvas id="ageChart"></canvas>
            </div>
        </div>
    </main>

    <div id="errorOverlay" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl max-w-md w-full text-center shadow-2xl">
            <i data-lucide="alert-circle" class="w-16 h-16 text-rose-500 mx-auto mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">No Data Received</h2>
            <p class="text-slate-600 mb-6">The connection to Supabase was successful, but the table returned 0 rows. This is usually due to RLS policies or an empty table.</p>
            <button onclick="window.location.reload()" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold hover:bg-indigo-700 transition">Retry Connection</button>
        </div>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL = 'https://edlheufkxcyuxontunvm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkbGhldWZreGN5dXhvbnR1bnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjA2ODAsImV4cCI6MjA4MzQzNjY4MH0.BV77ylA7W3H7qd-Y2ty0bZW2KYE3A87uN1rPI1gCZQo';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let masterData = [];
        let activeCharts = {};

        // Helper: Native Date Formatting (Replaces date-fns)
        const getMoYr = (date) => date.toLocaleString('default', { month: 'short', year: 'numeric' });

        async function init() {
            lucide.createIcons();
            console.log("Initializing Dashboard...");

            const { data, error } = await sb.from('database').select('*');

            if (error || !data || data.length === 0) {
                console.error("Fetch Error:", error);
                document.getElementById('errorOverlay').classList.remove('hidden');
                return;
            }

            // Normalization & Cleaning
            masterData = data.map(row => {
                // Find keys case-insensitively
                const getVal = (possibleKeys) => {
                    const key = Object.keys(row).find(k => possibleKeys.includes(k.toLowerCase().trim()));
                    return row[key];
                };

                return {
                    ...row,
                    date: new Date(getVal(['date'])),
                    amount: parseFloat(getVal(['amount'])) || 0,
                    category: getVal(['category']) || 'Uncategorized',
                    package_name: getVal(['package_name', 'package_name']) || 'General',
                    location: getVal(['location']) || 'Unknown',
                    gender: getVal(['gender']) || 'N/A',
                    age_bracket: getVal(['age_bracket']) || 'N/A'
                };
            }).filter(d => !isNaN(d.date.getTime()));

            setupSlicers();
            render();

            // Listeners
            ['monthSlicer', 'categorySlicer', 'packageSlicer'].forEach(id => {
                document.getElementById(id).addEventListener('change', render);
            });
        }

        function setupSlicers() {
            const populate = (id, items) => {
                const el = document.getElementById(id);
                el.innerHTML = '<option value="all">All ' + id.replace('Slicer','s') + '</option>';
                [...new Set(items)].sort().forEach(item => {
                    if(!item) return;
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = item;
                    el.appendChild(opt);
                });
            };

            populate('monthSlicer', masterData.map(d => getMoYr(d.date)));
            populate('categorySlicer', masterData.map(d => d.category));
            populate('packageSlicer', masterData.map(d => d.package_name));
        }

        function render() {
            const filters = {
                month: document.getElementById('monthSlicer').value,
                cat: document.getElementById('categorySlicer').value,
                pack: document.getElementById('packageSlicer').value
            };

            const filtered = masterData.filter(d => {
                return (filters.month === 'all' || getMoYr(d.date) === filters.month) &&
                       (filters.cat === 'all' || d.category === filters.cat) &&
                       (filters.pack === 'all' || d.package_name === filters.pack);
            });

            updateCards(filtered);
            updateLineCharts(filtered);
            updateDonuts(filtered);
        }

        function updateCards(data) {
            if (data.length === 0) return;

            const sorted = [...data].sort((a, b) => b.date - a.date);
            const latest = sorted[0].date;
            const lMo = latest.getMonth(), lYr = latest.getFullYear();

            const pDate = new Date(lYr, lMo - 1, 1);
            const pMo = pDate.getMonth(), pYr = pDate.getFullYear();

            const getStats = (m, y) => {
                const sub = data.filter(d => d.date.getMonth() === m && d.date.getFullYear() === y);
                return { rev: sub.reduce((sum, d) => sum + d.amount, 0), cen: sub.length };
            };

            const curr = getStats(lMo, lYr);
            const prev = getStats(pMo, pYr);
            const diff = prev.rev ? ((curr.rev - prev.rev) / prev.rev) * 100 : 0;

            document.getElementById('currRev').textContent = `₱${curr.rev.toLocaleString()}`;
            document.getElementById('currCensus').textContent = `${curr.cen} Patients`;
            document.getElementById('prevRev').textContent = `₱${prev.rev.toLocaleString()}`;
            document.getElementById('prevCensus').textContent = `${prev.cen} Patients`;
            
            const vEl = document.getElementById('varRev');
            vEl.textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(1)}%`;
            vEl.className = `text-3xl font-black ${diff >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;
        }

        function updateLineCharts(data) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const thisYear = new Date().getFullYear();

            const getYearly = (yr) => months.map((_, i) => {
                const sub = data.filter(d => d.date.getFullYear() === yr && d.date.getMonth() === i);
                return { rev: sub.reduce((s, d) => s + d.amount, 0), cen: sub.length };
            });

            const cy = getYearly(thisYear);
            const py = getYearly(thisYear - 1);

            draw('revChart', 'line', months, [
                { label: `${thisYear} Revenue`, data: cy.map(v => v.rev), borderColor: '#6366f1', backgroundColor: '#6366f122', fill: true, tension: 0.4 },
                { label: `${thisYear - 1} Revenue`, data: py.map(v => v.rev), borderColor: '#cbd5e1', borderDash: [5,5], tension: 0.4 }
            ]);

            draw('cenChart', 'line', months, [
                { label: `${thisYear} Census`, data: cy.map(v => v.cen), borderColor: '#06b6d4', tension: 0.4 },
                { label: `${thisYear - 1} Census`, data: py.map(v => v.cen), borderColor: '#cbd5e1', borderDash: [5,5], tension: 0.4 }
            ]);
        }

        function updateDonuts(data) {
            const grp = (key) => {
                const counts = {};
                data.forEach(d => counts[d[key]] = (counts[d[key]] || 0) + 1);
                return { keys: Object.keys(counts), vals: Object.values(counts) };
            };

            const l = grp('location'), g = grp('gender'), a = grp('age_bracket');
            
            draw('locChart', 'bar', l.keys, [{ label: 'Patients', data: l.vals, backgroundColor: '#818cf8', borderRadius: 8 }]);
            draw('genChart', 'doughnut', g.keys, [{ data: g.vals, backgroundColor: ['#6366f1', '#f472b6', '#fbbf24'] }]);
            draw('ageChart', 'pie', a.keys, [{ data: a.vals, backgroundColor: ['#2dd4bf', '#fb7185', '#38bdf8', '#fbbf24', '#818cf8'] }]);
        }

        function draw(id, type, labels, datasets) {
            if (activeCharts[id]) activeCharts[id].destroy();
            activeCharts[id] = new Chart(document.getElementById(id), {
                type,
                data: { labels, datasets },
                options: { 
                    responsive: true, 
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxSize: 6 } } },
                    scales: type === 'line' || type === 'bar' ? { y: { beginAtZero: true, grid: { display: false } } } : {}
                }
            });
        }

        // Run
        init();
    </script>
</body>
</html>
