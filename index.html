<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Analytics - 2024/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <nav class="bg-indigo-900 text-white px-8 py-4 flex flex-wrap justify-between items-center sticky top-0 z-50 shadow-xl">
        <div class="flex items-center gap-3">
            <i data-lucide="database" class="text-indigo-300"></i>
            <h1 class="text-lg font-black uppercase tracking-tight">Analytics Portal</h1>
        </div>
        <div class="flex flex-wrap gap-2 text-slate-900">
            <select id="monthSlicer" class="rounded px-3 py-1.5 text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-400">
                <option value="all">Loading Months...</option>
            </select>
            <select id="categorySlicer" class="rounded px-3 py-1.5 text-sm bg-white outline-none">
                <option value="all">All Categories</option>
            </select>
            <select id="packageSlicer" class="rounded px-3 py-1.5 text-sm bg-white outline-none">
                <option value="all">All Packages</option>
            </select>
        </div>
    </nav>

    <main class="p-6 max-w-7xl mx-auto space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-indigo-500">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Selected Period Revenue</p>
                <h2 id="currRev" class="text-4xl font-black mt-2 text-slate-800">₱0</h2>
                <p id="currCensus" class="text-indigo-600 text-sm font-bold mt-1">0 Patients</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-slate-300">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Growth Variance</p>
                <h2 id="varRev" class="text-4xl font-black mt-2">0%</h2>
                <p id="varLabel" class="text-slate-500 text-sm mt-1">Vs. Previous Month</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-emerald-500">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Record Count</p>
                <h2 id="totalCount" class="text-4xl font-black mt-2 text-slate-800">0</h2>
                <p class="text-slate-500 text-sm mt-1">Records in Database</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="revChart" height="200"></canvas></div>
            <div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="cenChart" height="200"></canvas></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="locChart"></canvas></div>
            <div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="genChart"></canvas></div>
            <div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="ageChart"></canvas></div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://edlheufkxcyuxontunvm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkbGhldWZreGN5dXhvbnR1bnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjA2ODAsImV4cCI6MjA4MzQzNjY4MH0.BV77ylA7W3H7qd-Y2ty0bZW2KYE3A87uN1rPI1gCZQo';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let masterData = [];
        let charts = {};

        // Helper: Consistent Month-Year naming
        const getLabel = (d) => d.toLocaleString('en-US', { month: 'short', year: 'numeric' });

        async function init() {
            lucide.createIcons();
            const { data, error } = await sb.from('database').select('*');
            
            if (error) {
                console.error("Supabase Error:", error);
                return;
            }

            // DEBUG: See what is coming from Supabase
            console.log("Raw rows fetched:", data.length);

            masterData = data.map(row => {
                const d = new Date(row.date);
                return {
                    ...row,
                    date: d,
                    monthYear: getLabel(d),
                    amount: parseFloat(String(row.amount).replace(/[^0-9.-]+/g,"")) || 0
                };
            }).filter(d => !isNaN(d.date.getTime()));

            console.log("Unique Months Found:", [...new Set(masterData.map(d => d.monthYear))]);

            setupSlicers();
            render();

            ['monthSlicer', 'categorySlicer', 'packageSlicer'].forEach(id => {
                document.getElementById(id).addEventListener('change', render);
            });
        }

        function setupSlicers() {
            const populate = (id, items) => {
                const el = document.getElementById(id);
                el.innerHTML = `<option value="all">All ${id.replace('Slicer','s')}</option>`;
                items.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = item;
                    el.appendChild(opt);
                });
            };

            // Sorted list of months found in data
            const monthList = [...new Set(masterData.map(d => d.monthYear))].sort((a,b) => new Date(a) - new Date(b));
            populate('monthSlicer', monthList);

            populate('categorySlicer', [...new Set(masterData.map(d => d.category))].sort());
            populate('packageSlicer', [...new Set(masterData.map(d => d.package_name))].sort());
        }

        function render() {
            const m = document.getElementById('monthSlicer').value;
            const c = document.getElementById('categorySlicer').value;
            const p = document.getElementById('packageSlicer').value;

            const filtered = masterData.filter(d => {
                return (m === 'all' || d.monthYear === m) &&
                       (c === 'all' || d.category === c) &&
                       (p === 'all' || d.package_name === p);
            });

            document.getElementById('totalCount').textContent = masterData.length.toLocaleString();

            updateMetrics(filtered);
            updateTrends(filtered);
            updatePies(filtered);
        }

        function updateMetrics(data) {
            if (!data.length) return;
            const revenue = data.reduce((sum, d) => sum + d.amount, 0);
            document.getElementById('currRev').textContent = `₱${revenue.toLocaleString()}`;
            document.getElementById('currCensus').textContent = `${data.length} Patients`;

            // Variance logic (Current selection vs selection - 1 month)
            // Just for visual effect in this simplified render
            document.getElementById('varRev').textContent = "---"; 
        }

        function updateTrends(data) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Auto-detect Years in the filtered data
            const years = [...new Set(masterData.map(d => d.date.getFullYear()))].sort((a,b) => b-a);
            const cy = years[0] || 2025;
            const py = years[1] || 2024;

            const getYearStats = (y) => months.map((_, i) => {
                const sub = masterData.filter(d => d.date.getFullYear() === y && d.date.getMonth() === i);
                return { rev: sub.reduce((s, d) => s + d.amount, 0), cen: sub.length };
            });

            const current = getYearStats(cy), previous = getYearStats(py);

            draw('revChart', 'line', months, [
                { label: `${cy} Revenue`, data: current.map(v => v.rev), borderColor: '#6366f1', tension: 0.3 },
                { label: `${py} Revenue`, data: previous.map(v => v.rev), borderColor: '#cbd5e1', borderDash: [4,4], tension: 0.3 }
            ], 'Revenue Trend');

            draw('cenChart', 'line', months, [
                { label: `${cy} Census`, data: current.map(v => v.cen), borderColor: '#06b6d4', tension: 0.3 },
                { label: `${py} Census`, data: previous.map(v => v.cen), borderColor: '#cbd5e1', borderDash: [4,4], tension: 0.3 }
            ], 'Patient Census');
        }

        function updatePies(data) {
            const grp = (key) => {
                const map = {};
                data.forEach(d => map[d[key]] = (map[d[key]] || 0) + 1);
                return { k: Object.keys(map), v: Object.values(map) };
            };
            const l = grp('location'), g = grp('gender'), a = grp('age_bracket');
            draw('locChart', 'bar', l.k, [{ label: 'Patients', data: l.v, backgroundColor: '#818cf8' }], 'Location');
            draw('genChart', 'doughnut', g.k, [{ data: g.v, backgroundColor: ['#6366f1', '#f472b6', '#fbbf24'] }], 'Gender');
            draw('ageChart', 'pie', a.k, [{ data: a.v, backgroundColor: ['#2dd4bf', '#fb7185', '#38bdf8', '#fbbf24'] }], 'Age');
        }

        function draw(id, type, labels, datasets, title) {
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type, data: { labels, datasets },
                options: { 
                    responsive: true, 
                    plugins: { title: { display: true, text: title }, legend: { position: 'bottom' } }
                }
            });
        }

        init();
    </script>
</body>
</html>
