<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <nav class="bg-white border-b border-slate-200 px-8 py-4 flex flex-wrap justify-between items-center sticky top-0 z-50 gap-4">
        <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
            <i data-lucide="layout-dashboard"></i> Clinical Insights
        </h1>
        <div class="flex flex-wrap gap-4">
            <select id="monthSlicer" class="border rounded-md px-3 py-2 text-sm bg-white shadow-sm outline-indigo-500">
                <option value="all">All Time</option>
            </select>
            <select id="categorySlicer" class="border rounded-md px-3 py-2 text-sm bg-white shadow-sm outline-indigo-500">
                <option value="all">All Categories</option>
            </select>
            <select id="packageSlicer" class="border rounded-md px-3 py-2 text-sm bg-white shadow-sm outline-indigo-500">
                <option value="all">All Packages</option>
            </select>
        </div>
    </nav>

    <main class="p-6 max-w-7xl mx-auto space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <p class="text-xs text-slate-500 font-bold uppercase">Latest Month</p>
                <h2 id="currRev" class="text-3xl font-bold mt-1">$0</h2>
                <p id="currCensus" class="text-indigo-600 text-sm font-medium mt-1">0 Patients</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <p class="text-xs text-slate-500 font-bold uppercase">Previous Month</p>
                <h2 id="prevRev" class="text-3xl font-bold mt-1 text-slate-600">$0</h2>
                <p id="prevCensus" class="text-slate-500 text-sm font-medium mt-1">0 Patients</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <p class="text-xs text-slate-500 font-bold uppercase">Revenue Variance</p>
                <div class="flex items-center gap-2 mt-1">
                    <h2 id="varRev" class="text-3xl font-bold">0%</h2>
                    <div id="varIconContainer"></div>
                </div>
                <p class="text-slate-400 text-xs mt-1">Vs. Previous Month</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="dollar-sign" class="w-4"></i> Revenue Trend</h3>
                <canvas id="revenueChart" height="150"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="users" class="w-4"></i> Census Trend</h3>
                <canvas id="censusChart" height="150"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold mb-4 text-sm text-center">Location Distribution</h3>
                <canvas id="locationChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold mb-4 text-sm text-center">Gender Split</h3>
                <canvas id="genderChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold mb-4 text-sm text-center">Age Brackets</h3>
                <canvas id="ageChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://edlheufkxcyuxontunvm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkbGhldWZreGN5dXhvbnR1bnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjA2ODAsImV4cCI6MjA4MzQzNjY4MH0.BV77ylA7W3H7qd-Y2ty0bZW2KYE3A87uN1rPI1gCZQo';
        const supabase = typeof supabase !== 'undefined' ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : window['supabase'].createClient(SUPABASE_URL, SUPABASE_KEY);

        let rawData = [];
        let charts = {};

        async function init() {
            lucide.createIcons();
            const { data, error } = await supabase.from('database').select('*');
            if (error) return console.error(error);
            
            rawData = data.map(d => ({ ...d, date: new Date(d.date) }));
            populateSlicers();
            updateDashboard();
            
            // Event Listeners
            ['monthSlicer', 'categorySlicer', 'packageSlicer'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateDashboard);
            });
        }

        function populateSlicers() {
            const categories = [...new Set(rawData.map(d => d.category))];
            const packages = [...new Set(rawData.map(d => d.package_name))];
            const months = [...new Set(rawData.map(d => dateFns.format(d.date, 'MMM yyyy')))];

            const fill = (id, list) => {
                const el = document.getElementById(id);
                list.forEach(item => {
                    if(!item) return;
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.textContent = item;
                    el.appendChild(opt);
                });
            };

            fill('categorySlicer', categories);
            fill('packageSlicer', packages);
            fill('monthSlicer', months);
        }

        function updateDashboard() {
            const mFilter = document.getElementById('monthSlicer').value;
            const cFilter = document.getElementById('categorySlicer').value;
            const pFilter = document.getElementById('packageSlicer').value;

            let filtered = rawData.filter(d => {
                const matchM = mFilter === 'all' || dateFns.format(d.date, 'MMM yyyy') === mFilter;
                const matchC = cFilter === 'all' || d.category === cFilter;
                const matchP = pFilter === 'all' || d.package_name === pFilter;
                return matchM && matchC && matchP;
            });

            renderCards(filtered);
            renderLineCharts(filtered);
            renderInfoCharts(filtered);
        }

        function renderCards(data) {
            if (data.length === 0) return;
            
            // Sort to find latest
            const sorted = [...data].sort((a, b) => b.date - a.date);
            const latestMonth = dateFns.startOfMonth(sorted[0].date);
            const prevMonth = dateFns.subMonths(latestMonth, 1);

            const getStats = (mo) => {
                const items = data.filter(d => dateFns.isSameMonth(d.date, mo));
                return {
                    rev: items.reduce((sum, d) => sum + (Number(d.amount) || 0), 0),
                    census: items.length
                };
            };

            const curr = getStats(latestMonth);
            const prev = getStats(prevMonth);

            document.getElementById('currRev').textContent = `$${curr.rev.toLocaleString()}`;
            document.getElementById('currCensus').textContent = `${curr.census} Patients`;
            document.getElementById('prevRev').textContent = `$${prev.rev.toLocaleString()}`;
            document.getElementById('prevCensus').textContent = `${prev.census} Patients`;

            const variance = prev.rev === 0 ? 0 : ((curr.rev - prev.rev) / prev.rev) * 100;
            const varEl = document.getElementById('varRev');
            varEl.textContent = `${variance.toFixed(1)}%`;
            varEl.className = `text-3xl font-bold ${variance >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;
        }

        function renderLineCharts(data) {
            const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const getYearlyData = (yearOffset) => {
                const targetYear = new Date().getFullYear() - yearOffset;
                return labels.map((_, i) => {
                    return data
                        .filter(d => d.date.getFullYear() === targetYear && d.date.getMonth() === i)
                        .reduce((sum, d) => ({ 
                            rev: sum.rev + (Number(d.amount) || 0), 
                            cen: sum.cen + 1 
                        }), {rev: 0, cen: 0});
                });
            };

            const cyData = getYearlyData(0);
            const pyData = getYearlyData(1);

            updateChart('revenueChart', 'line', labels, [
                { label: 'Current Year', data: cyData.map(d => d.rev), borderColor: '#4f46e5' },
                { label: 'Prev Year', data: pyData.map(d => d.rev), borderColor: '#cbd5e1', borderDash: [5,5] }
            ]);

            updateChart('censusChart', 'line', labels, [
                { label: 'Current Year', data: cyData.map(d => d.cen), borderColor: '#06b6d4' },
                { label: 'Prev Year', data: pyData.map(d => d.cen), borderColor: '#cbd5e1', borderDash: [5,5] }
            ]);
        }

        function renderInfoCharts(data) {
            const group = (key) => {
                const counts = {};
                data.forEach(d => counts[d[key]] = (counts[d[key]] || 0) + 1);
                return { labels: Object.keys(counts), values: Object.values(counts) };
            };

            const loc = group('location');
            updateChart('locationChart', 'bar', loc.labels, [{ label: 'Patients', data: loc.values, backgroundColor: '#6366f1' }]);

            const gen = group('gender');
            updateChart('genderChart', 'doughnut', gen.labels, [{ data: gen.values, backgroundColor: ['#818cf8', '#f472b6', '#fbbf24'] }]);

            const age = group('age_bracket');
            updateChart('ageChart', 'pie', age.labels, [{ data: age.values, backgroundColor: ['#2dd4bf', '#fb7185', '#38bdf8', '#fbbf24'] }]);
        }

        function updateChart(id, type, labels, datasets) {
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: type,
                data: { labels, datasets },
                options: { responsive: true, plugins: { legend: { display: type !== 'bar' } } }
            });
        }

        init();
    </script>
</body>
</html>
