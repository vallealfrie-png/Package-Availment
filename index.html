<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Health Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 text-slate-900 font-sans">

    <div id="loader" class="fixed inset-0 bg-slate-900/90 z-[100] flex flex-col items-center justify-center text-white">
        <div class="w-64 bg-slate-700 rounded-full h-2 mb-4 overflow-hidden">
            <div id="progressBar" class="bg-indigo-500 h-full w-0 transition-all duration-300"></div>
        </div>
        <p class="text-lg font-bold animate-pulse">Fetching 61,400+ Records...</p>
        <p id="loadStatus" class="text-slate-400 text-sm mt-2">Page 0 of 614</p>
    </div>

    <nav class="bg-indigo-900 text-white px-8 py-4 flex flex-wrap justify-between items-center sticky top-0 z-50 shadow-xl">
        <div class="flex items-center gap-3">
            <i data-lucide="activity" class="text-indigo-400"></i>
            <h1 class="text-xl font-black tracking-tighter uppercase">Clinical <span class="text-indigo-300">DataHub</span></h1>
        </div>
        <div class="flex flex-wrap gap-2 text-slate-900">
            <select id="monthSlicer" class="rounded px-3 py-2 text-xs font-bold uppercase outline-none"><option value="all">All Months</option></select>
            <select id="categorySlicer" class="rounded px-3 py-2 text-xs font-bold uppercase outline-none"><option value="all">All Categories</option></select>
            <select id="packageSlicer" class="rounded px-3 py-2 text-xs font-bold uppercase outline-none"><option value="all">All Packages</option></select>
        </div>
    </nav>

    <main class="p-6 max-w-[1600px] mx-auto space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-indigo-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Revenue</p>
                <h2 id="totalRev" class="text-3xl font-black mt-1">₱0</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-cyan-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Census</p>
                <h2 id="totalCen" class="text-3xl font-black mt-1">0</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-emerald-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Avg Transaction</p>
                <h2 id="avgTrans" class="text-3xl font-black mt-1">₱0</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-amber-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Records Loaded</p>
                <h2 id="recCount" class="text-3xl font-black mt-1">0</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-500 text-xs uppercase mb-4">Revenue Trend (2024 vs 2025)</h3>
                <canvas id="revChart" height="150"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-500 text-xs uppercase mb-4">Census Trend (2024 vs 2025)</h3>
                <canvas id="cenChart" height="150"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="locChart"></canvas></div>
            <div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="genChart"></canvas></div>
            <div class="bg-white p-6 rounded-2xl shadow-sm"><canvas id="ageChart"></canvas></div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://edlheufkxcyuxontunvm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkbGhldWZreGN5dXhvbnR1bnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjA2ODAsImV4cCI6MjA4MzQzNjY4MH0.BV77ylA7W3H7qd-Y2ty0bZW2KYE3A87uN1rPI1gCZQo';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let masterData = [];
        let charts = {};

        const getMoYr = (d) => d.toLocaleString('en-US', { month: 'short', year: 'numeric' });

        async function loadAllData() {
            lucide.createIcons();
            let allRows = [];
            let page = 0;
            const pageSize = 1000; // Fetching 1000 at a time is faster than 100
            const totalExpectedPages = 62; // 61,400 / 1000

            try {
                while (true) {
                    const { data, error } = await sb
                        .from('database')
                        .select('*')
                        .range(page * pageSize, (page + 1) * pageSize - 1);

                    if (error) throw error;
                    if (!data || data.length === 0) break;

                    allRows = [...allRows, ...data];
                    
                    // Update UI Progress
                    page++;
                    const progress = Math.min((page / totalExpectedPages) * 100, 100);
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('loadStatus').textContent = `Loaded ${allRows.length.toLocaleString()} records...`;

                    if (data.length < pageSize) break;
                }

                masterData = allRows.map(r => {
                    const d = new Date(r.date);
                    return {
                        ...r,
                        date: d,
                        moYr: getMoYr(d),
                        amount: parseFloat(String(r.amount).replace(/[^0-9.-]+/g,"")) || 0
                    };
                }).filter(d => !isNaN(d.date.getTime()));

                document.getElementById('loader').classList.add('hidden');
                setupSlicers();
                render();

            } catch (err) {
                console.error("Critical Load Error:", err);
                alert("Error loading data. See console.");
            }
        }

        function setupSlicers() {
            const populate = (id, items) => {
                const el = document.getElementById(id);
                el.innerHTML = `<option value="all">All ${id.replace('Slicer','')}</option>`;
                items.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = i;
                    el.appendChild(opt);
                });
            };

            const months = [...new Set(masterData.map(d => d.moYr))].sort((a,b) => new Date(a) - new Date(b));
            populate('monthSlicer', months);
            populate('categorySlicer', [...new Set(masterData.map(d => d.category))].sort());
            populate('packageSlicer', [...new Set(masterData.map(d => d.package_name))].sort());

            ['monthSlicer', 'categorySlicer', 'packageSlicer'].forEach(id => {
                document.getElementById(id).addEventListener('change', render);
            });
        }

        function render() {
            const f = {
                m: document.getElementById('monthSlicer').value,
                c: document.getElementById('categorySlicer').value,
                p: document.getElementById('packageSlicer').value
            };

            const filtered = masterData.filter(d => {
                return (f.m === 'all' || d.moYr === f.m) &&
                       (f.c === 'all' || d.category === f.c) &&
                       (f.p === 'all' || d.package_name === f.p);
            });

            // Update Cards
            const totalRev = filtered.reduce((s, d) => s + d.amount, 0);
            document.getElementById('totalRev').textContent = `₱${totalRev.toLocaleString()}`;
            document.getElementById('totalCen').textContent = filtered.length.toLocaleString();
            document.getElementById('avgTrans').textContent = `₱${(totalRev / (filtered.length || 1)).toLocaleString(undefined, {maximumFractionDigits:0})}`;
            document.getElementById('recCount').textContent = filtered.length.toLocaleString();

            updateCharts(filtered);
        }

        function updateCharts(data) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const yrs = [...new Set(masterData.map(d => d.date.getFullYear()))].sort((a,b) => b-a);
            const cy = yrs[0] || 2025, py = yrs[1] || 2024;

            const getSet = (y) => months.map((_, i) => {
                const sub = data.filter(d => d.date.getFullYear() === y && d.date.getMonth() === i);
                return { r: sub.reduce((s, d) => s + d.amount, 0), c: sub.length };
            });

            const cSet = getSet(cy), pSet = getSet(py);

            draw('revChart', 'line', months, [
                { label: `${cy} Revenue`, data: cSet.map(v => v.r), borderColor: '#6366f1', backgroundColor: '#6366f122', fill: true, tension: 0.3 },
                { label: `${py} Revenue`, data: pSet.map(v => v.r), borderColor: '#cbd5e1', borderDash: [5,5], tension: 0.3 }
            ]);

            draw('cenChart', 'line', months, [
                { label: `${cy} Census`, data: cSet.map(v => v.c), borderColor: '#06b6d4', tension: 0.3 },
                { label: `${py} Census`, data: pSet.map(v => v.c), borderColor: '#cbd5e1', borderDash: [5,5], tension: 0.3 }
            ]);

            const grp = (key) => {
                const o = {};
                data.forEach(d => o[d[key]] = (o[d[key]] || 0) + 1);
                const sorted = Object.entries(o).sort((a,b) => b[1] - a[1]).slice(0, 10);
                return { k: sorted.map(x => x[0]), v: sorted.map(x => x[1]) };
            };

            const l = grp('location'), g = grp('gender'), a = grp('age_bracket');
            draw('locChart', 'bar', l.k, [{ label: 'Patients', data: l.v, backgroundColor: '#818cf8' }], 'Top Locations');
            draw('genChart', 'doughnut', g.k, [{ data: g.v, backgroundColor: ['#6366f1', '#f472b6', '#fbbf24'] }], 'Gender');
            draw('ageChart', 'pie', a.k, [{ data: a.v, backgroundColor: ['#2dd4bf', '#fb7185', '#38bdf8', '#fbbf24'] }], 'Age Groups');
        }

        function draw(id, type, labels, datasets, title) {
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type, data: { labels, datasets },
                options: { 
                    responsive: true, 
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }, title: { display: !!title, text: title } }
                }
            });
        }

        loadAllData();
    </script>
</body>
</html>
