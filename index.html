<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">

    <nav class="bg-indigo-700 text-white px-8 py-4 flex flex-wrap justify-between items-center sticky top-0 z-50 shadow-lg">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <i data-lucide="activity"></i> Hospital Revenue Dashboard
        </h1>
        <div class="flex flex-wrap gap-3 text-slate-800">
            <select id="monthSlicer" class="rounded px-2 py-1 text-sm bg-white border-none outline-none"><option value="all">All Months</option></select>
            <select id="categorySlicer" class="rounded px-2 py-1 text-sm bg-white border-none outline-none"><option value="all">All Categories</option></select>
            <select id="packageSlicer" class="rounded px-2 py-1 text-sm bg-white border-none outline-none"><option value="all">All Packages</option></select>
        </div>
    </nav>

    <main class="p-6 max-w-7xl mx-auto space-y-6">
        <div id="statsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-indigo-500">
                <p class="text-xs font-bold text-slate-400 uppercase">Latest Month Revenue</p>
                <h2 id="currRev" class="text-3xl font-black mt-1">$0</h2>
                <p id="currCensus" class="text-indigo-600 text-sm font-bold mt-1">0 Patients</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-slate-300">
                <p class="text-xs font-bold text-slate-400 uppercase">Previous Month</p>
                <h2 id="prevRev" class="text-3xl font-black mt-1 text-slate-600">$0</h2>
                <p id="prevCensus" class="text-slate-500 text-sm font-bold mt-1">0 Patients</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow border-l-4 id="varBorder"">
                <p class="text-xs font-bold text-slate-400 uppercase">Growth Variance</p>
                <div class="flex items-center gap-2 mt-1">
                    <h2 id="varRev" class="text-3xl font-black">0%</h2>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow"><h3 class="font-bold mb-4">Revenue Trend</h3><canvas id="revChart"></canvas></div>
            <div class="bg-white p-6 rounded-xl shadow"><h3 class="font-bold mb-4">Patient Census</h3><canvas id="cenChart"></canvas></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow"><h3 class="text-center font-bold mb-4">By Location</h3><canvas id="locChart"></canvas></div>
            <div class="bg-white p-6 rounded-xl shadow"><h3 class="text-center font-bold mb-4">By Gender</h3><canvas id="genChart"></canvas></div>
            <div class="bg-white p-6 rounded-xl shadow"><h3 class="text-center font-bold mb-4">Age Brackets</h3><canvas id="ageChart"></canvas></div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://edlheufkxcyuxontunvm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkbGhldWZreGN5dXhvbnR1bnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjA2ODAsImV4cCI6MjA4MzQzNjY4MH0.BV77ylA7W3H7qd-Y2ty0bZW2KYE3A87uN1rPI1gCZQo';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let masterData = [];
        let activeCharts = {};

        async function loadData() {
            lucide.createIcons();
            console.log("Fetching from Supabase...");
            
            const { data, error } = await sb.from('database').select('*');
            
            if (error || !data || data.length === 0) {
                console.error("Connection Error or Empty Table:", error);
                document.body.innerHTML += `<div class="fixed inset-0 bg-red-100 flex items-center justify-center p-10 text-red-800 text-center">
                    <div><h1 class="text-2xl font-bold">No Data Found</h1><p>Check your RLS Policies or Table Name in Supabase.</p></div>
                </div>`;
                return;
            }

            // Normalization: Ensure properties exist regardless of casing
            masterData = data.map(row => {
                const findVal = (keys) => {
                    const found = Object.keys(row).find(k => keys.includes(k.toLowerCase()));
                    return row[found];
                };
                return {
                    ...row,
                    date: new Date(findVal(['date'])),
                    amount: parseFloat(findVal(['amount'])) || 0,
                    category: findVal(['category']) || 'N/A',
                    package_name: findVal(['package_name', 'packagename']) || 'N/A',
                    location: findVal(['location']) || 'N/A',
                    gender: findVal(['gender']) || 'N/A',
                    age_bracket: findVal(['age_bracket', 'agebracket']) || 'N/A'
                };
            }).filter(d => !isNaN(d.date.getTime()));

            setupSlicers();
            refreshDashboard();
            
            ['monthSlicer', 'categorySlicer', 'packageSlicer'].forEach(id => {
                document.getElementById(id).addEventListener('change', refreshDashboard);
            });
        }

        function setupSlicers() {
            const getUnique = (key) => [...new Set(masterData.map(d => d[key]))].sort();
            const populate = (id, items) => {
                const sel = document.getElementById(id);
                items.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = i;
                    sel.appendChild(opt);
                });
            };

            const months = [...new Set(masterData.map(d => dateFns.format(d.date, 'MMM yyyy')))];
            populate('monthSlicer', months);
            populate('categorySlicer', getUnique('category'));
            populate('packageSlicer', getUnique('package_name'));
        }

        function refreshDashboard() {
            const m = document.getElementById('monthSlicer').value;
            const c = document.getElementById('categorySlicer').value;
            const p = document.getElementById('packageSlicer').value;

            const filtered = masterData.filter(d => {
                return (m === 'all' || dateFns.format(d.date, 'MMM yyyy') === m) &&
                       (c === 'all' || d.category === c) &&
                       (p === 'all' || d.package_name === p);
            });

            updateCards(filtered);
            updateTrends(filtered);
            updateInfoGraphs(filtered);
        }

        function updateCards(data) {
            if(!data.length) return;
            const sorted = [...data].sort((a,b) => b.date - a.date);
            const latest = dateFns.startOfMonth(sorted[0].date);
            const previous = dateFns.subMonths(latest, 1);

            const stats = (mo) => {
                const sub = data.filter(d => dateFns.isSameMonth(d.date, mo));
                return { rev: sub.reduce((a, b) => a + b.amount, 0), cen: sub.length };
            };

            const c = stats(latest), p = stats(previous);
            const vari = p.rev ? ((c.rev - p.rev) / p.rev * 100) : 0;

            document.getElementById('currRev').textContent = `₱${c.rev.toLocaleString()}`;
            document.getElementById('currCensus').textContent = `${c.cen} Patients`;
            document.getElementById('prevRev').textContent = `₱${p.rev.toLocaleString()}`;
            document.getElementById('prevCensus').textContent = `${p.cen} Patients`;
            
            const vEl = document.getElementById('varRev');
            vEl.textContent = `${vari.toFixed(1)}%`;
            vEl.className = `text-3xl font-black ${vari >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;
        }

        function updateTrends(data) {
            const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            
            const getYearData = (yr) => labels.map((_, i) => {
                const monthSub = data.filter(d => d.date.getFullYear() === yr && d.date.getMonth() === i);
                return { rev: monthSub.reduce((a,b) => a + b.amount, 0), cen: monthSub.length };
            });

            const cy = getYearData(currentYear), py = getYearData(currentYear - 1);

            drawChart('revChart', 'line', labels, [
                { label: 'Current Year', data: cy.map(v => v.rev), borderColor: '#6366f1' },
                { label: 'Prev Year', data: py.map(v => v.rev), borderColor: '#cbd5e1', borderDash: [5,5] }
            ]);
            drawChart('cenChart', 'line', labels, [
                { label: 'Current Year', data: cy.map(v => v.cen), borderColor: '#06b6d4' },
                { label: 'Prev Year', data: py.map(v => v.cen), borderColor: '#cbd5e1', borderDash: [5,5] }
            ]);
        }

        function updateInfoGraphs(data) {
            const grp = (key) => {
                const obj = {};
                data.forEach(d => obj[d[key]] = (obj[d[key]] || 0) + 1);
                return { l: Object.keys(obj), v: Object.values(obj) };
            };

            const loc = grp('location'), gen = grp('gender'), age = grp('age_bracket');
            drawChart('locChart', 'bar', loc.l, [{ label: 'Total', data: loc.v, backgroundColor: '#818cf8' }]);
            drawChart('genChart', 'doughnut', gen.l, [{ data: gen.v, backgroundColor: ['#6366f1', '#f472b6', '#fbbf24'] }]);
            drawChart('ageChart', 'pie', age.l, [{ data: age.v, backgroundColor: ['#2dd4bf', '#fb7185', '#38bdf8', '#fbbf24'] }]);
        }

        function drawChart(id, type, labels, datasets) {
            if(activeCharts[id]) activeCharts[id].destroy();
            activeCharts[id] = new Chart(document.getElementById(id), {
                type, data: { labels, datasets }, options: { responsive: true }
            });
        }

        loadData();
    </script>
</body>
</html>
